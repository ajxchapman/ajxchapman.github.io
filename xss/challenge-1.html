<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/acorn/8.14.0/acorn.min.js"
    integrity="sha512-OLeHAVgUy2eGc9m8hcmI/zZYIUYHmlEuAIMlQD/njBsjc+UMZO/4Soi2bRggy5oCHv1Mb7v/b1egkPi3SM+JVQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f9fafb;
      color: #111827;
    }

    .form-container {
      width: 100%;
      max-width: 500px;
      padding: 24px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
      color: #374151;
    }

    .textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px 16px;
      border-radius: 6px;
      border: 2px solid #d1d5db;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
      transition: all 0.2s ease;
      box-sizing: border-box;
      resize: vertical;
    }

    .textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Error state */
    .textarea.error {
      border-color: #ef4444;
      background-color: #fef2f2;
    }

    .textarea.error:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .error-message {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-top: 8px;
      color: #ef4444;
      font-size: 13px;
      line-height: 1.4;
      animation: slideIn 0.2s ease-in-out;
    }

    .error-icon {
      flex-shrink: 0;
      margin-top: 2px;
    }

    .error-text {
      flex-grow: 1;
    }

    .counter {
      display: flex;
      justify-content: flex-end;
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }

    .counter.error {
      color: #ef4444;
      font-weight: 600;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .submit-button {
      background-color: #4f46e5;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .submit-button:hover {
      background-color: #4338ca;
    }

    .submit-button:active {
      transform: scale(0.98);
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>


  <div class="form-container">
    <form>
      <div class="form-group">
        <label for="message" class="form-label">
          Enter JavaScript code below, then click the "Parse" button to validate it.
          <br><b>Note</b> The only permitted function call is `run`. All other function calls will throw an error.
        </label>
        <textarea id="code" style="width: 100%; height: 200px;">run(alert, 1)</textarea>
        <input type="submit" value="Execute" />
        <!-- Error output -->
        <div class="error-message hidden">
          <span class="error-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </span>
          <span class="error-text"></span>
        </div>

        <script>

          function run(func, arg) {
            if (typeof func !== 'function') {
              throw new Error('First argument must be a function');
            }
            if ([Function, eval, setTimeout, setInterval, window.setImmediate].indexOf(func) >= 0) {
              throw new Error('String execution is not allowed');
            }
            return func(arg);
          }

          document.querySelector('form').addEventListener('submit', function (event) {
            const errorMessage = document.querySelector('.error-message');
            errorMessage.classList.add('hidden');
            try {
              const code = document.getElementById('code').value;
              const ast = acorn.parse(code);
              console.log(ast);

              // Walk the AST making sure all function calls are to a function named `run`
              const walk = (node) => {
                if (['ArrowFunctionExpression', "AssignmentExpression", "TaggedTemplateExpression", "ImportExpression", "ConditionalExpression", "IfStatement", "FunctionExpression", "FunctionDeclaration", "NewExpression", "SpreadElement"].indexOf(node.type) >= 0) {
                  throw new Error(`${node.type}s are not allowed`);
                }
                if (node.type === 'CallExpression') {
                  if (node.callee.name !== 'run') {
                    throw new Error('Function calls must be to a function named `run`');
                  }
                }
                for (const key in node) {
                  if (node[key] && typeof node[key] === 'object') {
                    walk(node[key]);
                  }
                }
              };

              walk(ast);
              eval(code);
            }
            catch (error) {

              errorMessage.classList.remove('hidden');
              errorMessage.querySelector('.error-text').textContent = error.message;
            }

            event.preventDefault();
            return false;
          });
        </script>
</body>
</html>