<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Exploit Archeology - Exploiting an old unknown Server Side Browser | Alex Chapman’s Blog</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Exploit Archeology - Exploiting an old unknown Server Side Browser" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I was recently hacking on a Bug Bounty target and identified an interesting API endpoint which would render user supplied HTML, and execute any included JavaScript. Exploiting Server Side Browser bugs has been a focus of mine for the past couple of years, so I set out to exploit this newly identified feature. This blog post details my journey into researching and exploiting what turned out to be a decade old Server Side Browser." />
<meta property="og:description" content="I was recently hacking on a Bug Bounty target and identified an interesting API endpoint which would render user supplied HTML, and execute any included JavaScript. Exploiting Server Side Browser bugs has been a focus of mine for the past couple of years, so I set out to exploit this newly identified feature. This blog post details my journey into researching and exploiting what turned out to be a decade old Server Side Browser." />
<link rel="canonical" href="https://blog.ajxchapman.com/posts/2024/05/08/exploit-archeology.html" />
<meta property="og:url" content="https://blog.ajxchapman.com/posts/2024/05/08/exploit-archeology.html" />
<meta property="og:site_name" content="Alex Chapman’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-08T00:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Exploit Archeology - Exploiting an old unknown Server Side Browser","dateModified":"2024-05-08T00:00:00-05:00","datePublished":"2024-05-08T00:00:00-05:00","@type":"BlogPosting","description":"I was recently hacking on a Bug Bounty target and identified an interesting API endpoint which would render user supplied HTML, and execute any included JavaScript. Exploiting Server Side Browser bugs has been a focus of mine for the past couple of years, so I set out to exploit this newly identified feature. This blog post details my journey into researching and exploiting what turned out to be a decade old Server Side Browser.","url":"https://blog.ajxchapman.com/posts/2024/05/08/exploit-archeology.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.ajxchapman.com/posts/2024/05/08/exploit-archeology.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

      <header class="page-header" role="banner">
        <a href="/">
          <h1 class="project-name">Alex Chapman's Blog</h1>
        </a>
        <h2 class="project-tagline">A tech blog about all things Bug Bounty, security and development.
</h2>
        <div class="social">
          <a href="https://twitter.com/ajxchapman" target="_blank"><img src="/assets/icons/twitter.svg"></a>
          <a href="https://infosec.exchange/@ajxchapman" rel="me" target="_blank"><img src="/assets/icons/mastodon.svg"></a>
          <a href="https://github.com/ajxchapman" target="_blank"><img src="/assets/icons/github.svg"></a>
          <a href="https://hackerone.com/ajxchapman" target="_blank"><img src="/assets/icons/hackerone.svg"></a>
          <a href="https://bugcrowd.com/ajxchapman" target="_blank"><img src="/assets/icons/bugcrowd.svg"></a>
        </div>
      </header>

    <main id="content" class="main-content" role="main">
      


  

  

  

  

  
    
    


<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="postheader">
    <a href="/">Home</a>
  </div>
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Exploit Archeology - Exploiting an old unknown Server Side Browser</h1>
    <p class="post-meta">
      <time datetime="2024-05-08T00:00:00-05:00" itemprop="datePublished">
        2024-05-08
      </time>
      
        • <span itemprop="category"><a href="/categories/exploits.html">Exploits</a></span>
      
  </header>
  <div class="post-content" itemprop="articleBody">
    <p>I was recently hacking on a Bug Bounty target and identified an interesting API endpoint which would render user supplied HTML, and execute any included JavaScript. Exploiting Server Side Browser bugs has been a focus of mine for the past couple of years, so I set out to exploit this newly identified feature. This blog post details my journey into researching and exploiting what turned out to be a decade old Server Side Browser.</p>

<!--more-->

<h1 id="recon">Recon</h1>

<p>The first step was to identify the Browser engine and version in use, this is <em>usually</em> a pretty simple task, of checking the <code class="highlighter-rouge">User-Agent</code> header of requests for external resources. So I sent an HTML payload into the target service with an <code class="highlighter-rouge">img</code> tag loading an image from a server I control (<em>Side note:</em> I use https://github.com/ajxchapman/reserv for all my server request bug hunting). This revealed the <code class="highlighter-rouge">User-Agent</code> of:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mozilla/5.0 (Unknown; Linux x86_64) AppleWebKit/538.1 (KHTML, like Gecko) Safari/538.1
</code></pre></div></div>

<p>… which is really not very helpful. You’d usually expect to see a <code class="highlighter-rouge">Chrome/124.0.0.0</code>, <code class="highlighter-rouge">Firefox/125.0</code>, or similar in there at least somewhere, which can disclose the Browser engine and version. No such luck here.</p>

<p>However, since I had JavaScript execution, I could concretely identify the Engine through browser specific APIs, e.g <code class="highlighter-rouge">Error.captureStackTrace</code> for Chrome, <code class="highlighter-rouge">document.preferredStyleSheetSet</code> for Firefox, and <code class="highlighter-rouge">webkitConvertPointFromPageToNode</code> for WebKit (Safari). In this case it appeared to be a WebKit based Engine.</p>

<p>From this, my first (and as it turned out, first incorrect) assumption was it was probably PhantomJS. I’d previously written an exploit for CVE-2014-1303, so packaged that up and sent it into the HTML service. No result… although I tried to two or three (or seven) more times just to be safe.</p>

<p>Begrudgingly accepting that it wasn’t PhantomJS, I set out to work out what approximate version of WebKit it was running. To do this, the <a href="https://caniuse.com/ciu/comparison">Browser Comparison feature</a> of <a href="https://caniuse.com">caniuse.com</a> came in really handy. Selecting several Safari versions, I could easily compare the feature support for each version:</p>

<p><img src="https://blog.ajxchapman.com/assets/exploit-archeology-2024/caniuse.png" alt="Can I Use Safari feature comparison" /></p>

<p>There are some discrepancies with the data from <a href="https://caniuse.com">caniuse.com</a> and <a href="https://developer.mozilla.org/">MDN</a>, using both of these sources a basic script could be created to determine the rough version of WebKit in use:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">version</span><span class="p">;</span>
<span class="nx">version</span> <span class="o">=</span> <span class="o">!</span><span class="nx">version</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">fetch</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">Safari WebKit 10.1</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">version</span><span class="p">;</span>
<span class="nx">version</span> <span class="o">=</span> <span class="o">!</span><span class="nx">version</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">includes</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">Safari WebKit 9</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">version</span><span class="p">;</span>
<span class="nx">version</span> <span class="o">=</span> <span class="o">!</span><span class="nx">version</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nb">document</span><span class="p">.</span><span class="nx">currentScript</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">object</span><span class="dl">"</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">Safari WebKit 8</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">version</span><span class="p">;</span>
<span class="nx">version</span> <span class="o">=</span> <span class="o">!</span><span class="nx">version</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">function</span><span class="dl">"</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">Safari WebKit 7</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">version</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">version</span><span class="p">);</span>
</code></pre></div></div>

<p>This revealed that the service was using WebKit that corresponds to Safari ~8, with an absolute date circa 2014 to 2015. Yes, nearly a decade old! Time to get my hands dirty and dust off my vulnerability excavation tools.</p>

<h1 id="research">Research</h1>

<p>Now that an approximate WebKit version and code development timeframe was known, I could go digging for old vulnerability reports, PoCs and exploits. Searches for WebKit vulnerabilities around that time came up with a lot of results for Sony PlayStation Jailbreaks. PS Vita had been released in 2011, and PS4 in 2013, and a common entrypoint to Jailbreaking these devices was WebKit. This was great news for me, as there were a fair number of PS Jailbreaks exploiting WebKit versions from around the time I was looking.</p>

<p>Hours of reading various Jailbreaking community sites, forums, wikis and GitHub repositories revealed several viable vulnerability candidates, from authors with names such as qwertyoruiop, Fire30 and RKX1209. Unfortunately for me, most of these main characters in the ~2015 PS Jailbreak scene were fond of writing illegible exploits, using minimal (and sometimes downright incomprehensible) comments and undefined static offsets all over the place. Some of the code was truely from another era.</p>

<p>I eventually unearthed one viable looking exploit with a clear writeup by a hacker known as xyz. The exploit targeted a Use After Free (UaF) vulnerability in the WebKit <code class="highlighter-rouge">JSArray::sortCompactedVector</code> function. Further searching did not identify a CVE related to this issue though, so I approached with some trepidation.</p>

<p>The <a href="https://blog.xyz.is/2016/webkit-360.html">JSArray::sortCompactedVector exploit writeup</a> from xyz included a basic PoC, which could be used to confirm whether the target service was vulnerable or not:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">almost_oversize</span> <span class="o">=</span> <span class="mh">0x3000</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">almost_oversize</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">o</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="mi">12345</span><span class="p">);</span> <span class="k">return</span> <span class="dl">""</span><span class="p">;</span> <span class="p">}</span>
<span class="nx">foo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">foo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">foo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">;</span>
<span class="nx">foo</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
</code></pre></div></div>

<p>So I batched this up in a <code class="highlighter-rouge">&lt;script&gt;</code> tag and sent it off to the target service. I got no response. This <em>could</em> have been due to the service crashing, or it <em>could</em> have been due to me not including any external logging :facepalm: With logging in place, I was able to confirm the target would crash when processing this script, fantastic!</p>

<p>It was at this point I realised that getting a reliable exploit using only a remote service was 1) going to increase the development and debugging time greatly, and 2) cause the remote service to crash a <em>lot</em>. I needed a local development environment to PoC this out on, before testing against live again.</p>

<p>Fortunately for me, my old friend PhantonJS was also vulnerable to this <code class="highlighter-rouge">JSArray::sortCompactedVector</code> UaF, so I could use that as a stand-in target for the exploit development phase.</p>

<h1 id="development">Development</h1>

<p>My first task was to actually get PhantomJS compiled with symbols (to make my inevitable exploit debugging a little less sanity destroying). The last public release of PhantomJS was from 2016(!), so pulling the code and starting with libraries from around that time seemed like a good start. After quite some attempts, I was able to compile PhantomJS with the following:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-ti</span> <span class="nt">--rm</span> <span class="nt">-v</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>:/working ubuntu:14.04 /bin/bash
apt-get update
apt-get <span class="nb">install </span>build-essential g++ flex bison gperf ruby perl <span class="se">\</span>
 libsqlite3-dev libfontconfig1-dev libicu-dev libfreetype6 libssl-dev <span class="se">\</span>
 libpng-dev libjpeg-dev python libx11-dev libxext-dev git


git clone https://github.com/ariya/phantomjs.git
<span class="nb">cd </span>phantomjs
git checkout 2.1.1
git submodule init
git submodule update
python build.py <span class="nt">--qmake-args</span><span class="o">=</span><span class="s2">"QMAKE_CFLAGS=-g"</span> <span class="nt">--qmake-args</span><span class="o">=</span><span class="s2">"QMAKE_CXXFLAGS=-g"</span>
</code></pre></div></div>

<p>Fortunately, the Ubuntu package repository for Ubuntu 14.04 is <em>still</em> live, making this a much less painful process than it otherwise could have been. With that done, it was time to get developing the PoC.</p>

<p>Following the exploit from xyz, all is going well until I got to:</p>
<blockquote>
  <p>Interestingly, this successfully corrupts a JSArray object on the Vita but crashes on Linux hitting a guard page. But this doesn’t matter because we’re not exploiting Linux.</p>
</blockquote>

<p>But <em>I</em> am exploiting Linux xyz! What do I do now??!? On PS Vita, the vulnerability can be used to scan contiguous memory pages for a target to corrupt, to gain the basic <code class="highlighter-rouge">read</code>, <code class="highlighter-rouge">write</code> and <code class="highlighter-rouge">addrOf</code> primitives. The issue on Linux is that guard pages, memory pages without <code class="highlighter-rouge">rw</code> permissions, are placed in between <code class="highlighter-rouge">rw</code> pages, breaking up the contiguous memory region. If you attempt to read or write to a guard page a SIGSEGV will be raised, killing the process, which is less than ideal.</p>

<p><em>For those not intimately familiar with browser exploitation, these primitives are the basic building blocks of most exploits. The <code class="highlighter-rouge">read</code> primitive allows reading any memory address, the <code class="highlighter-rouge">write</code> primitive allows writing an arbitrary value to any memory address, and the <code class="highlighter-rouge">addrOf</code> primitive discloses the memory address of a given JavaScript object. From these three primitives, arbitrary shellcode execution can eventually be built.</em></p>

<p>At this point I was left with a corrupted <code class="highlighter-rouge">ArrayWithDouble</code> (an array with all elements being of type <code class="highlighter-rouge">double</code>) with a length of <code class="highlighter-rouge">0x80000000</code>, allowing out of bound (oob) read and write to memory <em>after</em> the corrupted array. By placing an object array in memory after the corrupted array, the <code class="highlighter-rouge">addrOf</code> primitive could easily be created, leaving the <code class="highlighter-rouge">read</code> and <code class="highlighter-rouge">write</code> primitives. To create the <code class="highlighter-rouge">read</code> and <code class="highlighter-rouge">write</code> primitives, the backing address pointer of a <code class="highlighter-rouge">Float64Array</code> can be corrupted, making the arbitrary memory addresses referenceable. Unfortunately, to corrupt this pointer requires a pointer dereference, so cannot simply be done using the corrupted oob array read / write. I needed an arbitrary memory write to create my arbitrary memory write it seemed :facepalm:</p>

<p>Scanning through the oob contents of the corrupted array, I noticed a pointer to the start of the current memory region. Using this, it was possible to reliably calculate the address of the corrupted array. At this point an idea formed. If I could get a <code class="highlighter-rouge">Float64Array</code> in memory <em>after</em> the oob array (and learn it’s address using the <code class="highlighter-rouge">addrOf</code> primitive), and it’s <code class="highlighter-rouge">TypedArray</code> pointer (the structure which hold the backing store pointer) was <em>also</em> after the oob array, I could use relative reads and writes from the oob array to corrupt the backing store, without hitting those pesky guard pages. Some revisions and cursing later, this technique gave me the final <code class="highlighter-rouge">read</code> and <code class="highlighter-rouge">write</code> primitives.</p>

<p>Was this the most efficient method for exploiting this issue on Linux? I have no idea! As you may have noticed by now, I am by no means a expert exploiting ancient WebKit issues. If you know of an easier method I <em>could</em> have used drop me the details on <a href="https://twitter.com/ajxchapman">Twitter</a>!</p>

<h1 id="exploitation">Exploitation</h1>

<p>With the basic primitives in hand, the final step was to use them to get arbitrary shellcode execution. In the PlayStation Jailbreaks I was learning (*cough* copying *cough*) from, Return Oriented Programing (ROP) was always used in the final stage to execute the desired shellcode. In this case, I didn’t have access to the target executable, only my PhantomJS based development environment, which wouldn’t do for ROP chain development. So I came up with a new great idea, I’d scan the executable memory dynamically looking for the ROP gadgets I needed to map <code class="highlighter-rouge">rwx</code> memory, copy in shellcode and jump into it… how hard could it be?</p>

<p>A couple of notes at this point 1) It would be hard! 2) If I had stopped to think, rather than blindly follow what others before me did I would have saved myself a world of pain.</p>

<p>A long time of playing with ROP I got a feel for what gadgets I would require to achieve shellcode execution, so then I <em>just</em> had to write ROP gadget discovery and ROP chain compilation functions in JavaScript. With basic gadget searching implemented I ran it against the target to see if it would even work, which it didn’t! The first couple of dozen memory reads worked as expected, but then odd results were being returned, which did not appear to be consistent with what I was expecting.</p>

<p><img src="https://blog.ajxchapman.com/assets/exploit-archeology-2024/hourslater.png" alt="Hours of Debugging later" /></p>

<p>I realised, due to repeated calls, the <code class="highlighter-rouge">read</code> primitive function was being Just In Time (JIT) compiled. During JIT compilation, the corrupted array length check was re-added, preventing overwrite of the <code class="highlighter-rouge">Float64Array</code> backing address. I had very much mistakenly assumed that JIT was either not yet implemented in this WebKit version, or had been disabled like in PhantomJS. <em>Editors Note: JIT is <strong>NOT</strong> disabled in PhantonJS, another assumption that has cost me significant time writing exploits :facepalm:.</em></p>

<p>JIT is a gift from browser developers to exploit authors. Not only is it hugely complex, introducing <em>many</em> vulnerabilities in browser engines, it also necessitates memory with <code class="highlighter-rouge">rwx</code> protections (or at least <code class="highlighter-rouge">rw-</code> then subsequently updated to <code class="highlighter-rouge">r-x</code>).</p>

<p>In this version of WebKit, JIT pages were left with <code class="highlighter-rouge">rwx</code> memory protections. So despite all my ROP research and development, the actual method of gaining shellcode execution I ended up with was to simply force a function to be JIT compiled, then overwrite the resulting function instructions in memory, then call the function. Much easier!</p>

<h1 id="conclusion">Conclusion</h1>

<p>After painstakingly producing this reliable Remote Code Execution PoC and confirming execution on the target, I submitted the Bug Bounty report very much hoping for, if not actually expecting, a big payout… can you guess where this is going yet? The Bug Bounty program promptly responded to my report, praising the amount of effort that had clearly gone into this issue and informing me the vulnerability actually exists in a 3rd party service. Oh. On to reporting the issue to the 3rd party, who <em>doesn’t</em> have a Bug Bounty program… and who never responded to any of my multiple emails attempting to disclose the issue to them.</p>

<p>Oh well… on to the next one.</p>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://www.psdevwiki.com/ps4/Vulnerabilities">https://www.psdevwiki.com/ps4/Vulnerabilities</a></li>
  <li><a href="https://blog.xyz.is/2016/webkit-360.html">https://blog.xyz.is/2016/webkit-360.html</a></li>
</ul>


  </div>

  <div class="postfooter">
    <a href="/">Home</a>
    
      <a href="/categories/exploits.html">More exploit posts</a>
    
  </div>
</article>



      <footer class="site-footer">
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>
